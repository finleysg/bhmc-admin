name: Deploy App

on:
  workflow_dispatch:
    inputs:
      app:
        description: "App to deploy"
        required: true
        type: choice
        options:
          - api
          - public
          - web
      tag:
        description: "Version tag (auto-generated if empty)"
        required: false
        type: string

jobs:
  create-tag:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version tag
        id: version
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            DATE=$(date +%Y.%m.%d)
            PREFIX="v${DATE}"
            EXISTING=$(git tag -l "${PREFIX}.*" | sort -V | tail -1)
            if [ -z "$EXISTING" ]; then
              NUM=1
            else
              LAST_NUM=$(echo "$EXISTING" | sed "s/${PREFIX}\.//")
              NUM=$((LAST_NUM + 1))
            fi
            TAG="${PREFIX}.${NUM}"
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
          fi

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

  lint-test:
    runs-on: ubuntu-latest
    needs: create-tag
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build domain package
        run: pnpm --filter @repo/domain build

      - name: Lint
        run: pnpm --filter ${{ inputs.app }} lint

      - name: Test
        run: pnpm --filter ${{ inputs.app }} test

  deploy-api:
    if: inputs.app == 'api'
    runs-on: ubuntu-latest
    needs: [create-tag, lint-test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy captain-definition
        run: cp apps/api/captain-definition .

      - name: Create deployment tarball
        run: |
          tar -cvf deploy.tar \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='apps/web' \
            --exclude='apps/public' \
            captain-definition \
            package.json \
            pnpm-lock.yaml \
            pnpm-workspace.yaml \
            tsconfig.json \
            apps/api \
            packages/domain

      - name: Deploy to CapRover
        uses: caprover/deploy-from-github@v1.2.0
        with:
          server: ${{ vars.CAPROVER_URL }}
          app: ${{ vars.CAPROVER_API_APP }}
          token: ${{ secrets.CAPROVER_API_TOKEN }}

  deploy-public:
    if: inputs.app == 'public'
    runs-on: ubuntu-latest
    needs: [create-tag, lint-test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build domain package
        run: pnpm --filter @repo/domain build

      - name: Create production env file
        run: |
          cat > apps/public/.env.production << EOF
          VITE_API_URL=${{ vars.VITE_API_URL }}
          VITE_AUTH_URL=${{ vars.VITE_AUTH_URL }}
          VITE_SERVER_URL=${{ vars.VITE_SERVER_URL }}
          VITE_CURRENT_ENVIRONMENT=production
          VITE_STRIPE_PUBLIC_KEY=${{ secrets.VITE_STRIPE_PUBLIC_KEY }}
          VITE_GIPHY_API_KEY=${{ secrets.VITE_GIPHY_API_KEY }}
          VITE_SENIOR_AGE=62
          VITE_SENIOR_COMPETITION_AGE=50
          VITE_VERSION=${{ needs.create-tag.outputs.version }}
          VITE_MODE=Live
          EOF

      - name: Build public app
        run: pnpm --filter @repo/public build

      - name: Create deployment tarball
        run: |
          cp apps/public/captain-definition .
          tar -cvf deploy.tar \
            captain-definition \
            -C apps/public dist

      - name: Deploy to CapRover
        uses: caprover/deploy-from-github@v1.2.0
        with:
          server: ${{ vars.CAPROVER_URL }}
          app: ${{ vars.CAPROVER_PUBLIC_APP }}
          token: ${{ secrets.CAPROVER_PUBLIC_TOKEN }}

  deploy-web:
    if: inputs.app == 'web'
    runs-on: ubuntu-latest
    needs: [create-tag, lint-test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy captain-definition
        run: cp apps/web/captain-definition .

      - name: Create production env file
        run: |
          echo "NEXT_PUBLIC_DJANGO_API_URL=${{ vars.NEXT_PUBLIC_DJANGO_API_URL }}" > apps/web/.env.production

      - name: Create deployment tarball
        run: |
          tar -cvf deploy.tar \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='apps/api' \
            --exclude='apps/public' \
            captain-definition \
            package.json \
            pnpm-lock.yaml \
            pnpm-workspace.yaml \
            tsconfig.json \
            apps/web \
            packages/domain

      - name: Deploy to CapRover
        uses: caprover/deploy-from-github@v1.2.0
        with:
          server: ${{ vars.CAPROVER_URL }}
          app: ${{ vars.CAPROVER_ADMIN_APP }}
          token: ${{ secrets.CAPROVER_ADMIN_TOKEN }}
