name: Deploy to CapRover

on:
  push:
    tags:
      - "v*"

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install CapRover CLI
        run: npm install -g caprover

      - name: Create captain-definition
        run: |
          echo '{"schemaVersion":2,"dockerfilePath":"./apps/api/Dockerfile"}' > captain-definition

      - name: Create deployment tarball
        run: |
          tar -cvf deploy-api.tar \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='apps/web' \
            captain-definition \
            package.json \
            pnpm-lock.yaml \
            pnpm-workspace.yaml \
            tsconfig.json \
            apps/api \
            packages/domain

      - name: Deploy API to CapRover
        run: |
          caprover deploy \
            --caproverUrl ${{ vars.CAPROVER_URL }} \
            --caproverPassword ${{ secrets.CAPROVER_PASSWORD }} \
            --appName ${{ vars.CAPROVER_API_APP }} \
            --tarFile deploy-api.tar

  deploy-web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install CapRover CLI
        run: npm install -g caprover

      - name: Create captain-definition
        run: |
          echo '{"schemaVersion":2,"dockerfilePath":"./apps/web/Dockerfile"}' > captain-definition

      - name: Create production env file
        run: |
          echo "NEXT_PUBLIC_DJANGO_API_URL=${{ vars.NEXT_PUBLIC_DJANGO_API_URL }}" > apps/web/.env.production

      - name: Create deployment tarball
        run: |
          tar -cvf deploy-admin.tar \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='apps/api' \
            captain-definition \
            package.json \
            pnpm-lock.yaml \
            pnpm-workspace.yaml \
            tsconfig.json \
            apps/web \
            packages/domain

      - name: Deploy Admin to CapRover
        run: |
          caprover deploy \
            --caproverUrl ${{ vars.CAPROVER_URL }} \
            --caproverPassword ${{ secrets.CAPROVER_PASSWORD }} \
            --appName ${{ vars.CAPROVER_ADMIN_APP }} \
            --tarFile deploy-admin.tar
